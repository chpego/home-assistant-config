template:
  - sensor:
      - name: unavailable_entities
        unique_id: unavailable_entities
        unit_of_measurement: entities
        state: |
          {{  expand(states)
              | selectattr('state', 'eq', 'unavailable')
              | selectattr('attributes.unavailability_expected', 'undefined')
              | list
              | count
          }}
        attributes:
          entities: |
            {{  expand(states)
                | selectattr('state', 'eq', 'unavailable')
                | selectattr('attributes.unavailability_expected', 'undefined')
                | map(attribute='attributes.friendly_name') 
                | list
                | sort
            }}
